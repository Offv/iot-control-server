version: '3.8'

services:
  # MQTT Broker (shared between units)
  mqtt:
    image: eclipse-mosquitto:latest
    ports:
      - "1883:1883"  # MQTT
      - "9001:9001"  # WebSocket
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log

  # Unit 1 Services
  backend-unit1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      - IOLINK_IP=${UNIT1_IOLINK_IP:-192.168.30.29}
      - DEVICE_ID=${UNIT1_DEVICE_ID:-00-02-01-6D-55-8A}
      - UNIT_NAME=unit1
      - TEMP_TOPIC=instrument/unit1/temperature
      - CONFIG_PATH=/app/config/iolink_config.yml
    volumes:
      - ./config:/app/config
    depends_on:
      - mqtt

  frontend-unit1:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      - VITE_MQTT_HOST=${MQTT_HOST:-localhost}
      - VITE_MQTT_PORT=1883
      - VITE_MQTT_WS_PORT=9001
      - VITE_HTR_A_IP=${UNIT1_IOLINK_IP:-192.168.30.29}
      - VITE_HTR_A_DEVICE_ID=${UNIT1_DEVICE_ID:-00-02-01-6D-55-8A}
      - VITE_HTR_A_TOPIC=instrument/unit1/temperature
      - VITE_UNIT_NAME=unit1
    ports:
      - "3001:80"
    depends_on:
      - mqtt
      - backend-unit1

  # Unit 2 Services (commented out for initial testing)
  # backend-unit2:
  #   build:
  #     context: ./backend
  #     dockerfile: Dockerfile
  #   environment:
  #     - MQTT_HOST=mqtt
  #     - MQTT_PORT=1883
  #     - IOLINK_IP=${UNIT2_IOLINK_IP:-192.168.30.33}
  #     - DEVICE_ID=${UNIT2_DEVICE_ID:-00-02-01-6D-55-86}
  #     - UNIT_NAME=unit2
  #     - TEMP_TOPIC=instrument/unit2/temperature
  #     - CONFIG_PATH=/app/config/iolink_config.yml
  #   volumes:
  #     - ./config:/app/config
  #   depends_on:
  #     - mqtt

  # frontend-unit2:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   environment:
  #     - VITE_MQTT_HOST=${MQTT_HOST:-localhost}
  #     - VITE_MQTT_PORT=1883
  #     - VITE_MQTT_WS_PORT=9001
  #     - VITE_HTR_A_IP=${UNIT2_IOLINK_IP:-192.168.30.33}
  #     - VITE_HTR_A_DEVICE_ID=${UNIT2_DEVICE_ID:-00-02-01-6D-55-86}
  #     - VITE_HTR_A_TOPIC=instrument/unit2/temperature
  #     - VITE_UNIT_NAME=unit2
  #   ports:
  #     - "3002:80"
  #   depends_on:
  #     - mqtt
  #     - backend-unit2 