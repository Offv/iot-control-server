# v1.02 Discovery-Based Installation System
## IoT Control Server - Scalable Multi-Unit Installation

### ğŸ“… **Date**: August 1, 2025
### ğŸ¯ **Goal**: Create discovery-based installation for multiple units and heaters
### ğŸ·ï¸ **Branch**: `v1.02-installation-fixes`

---

## ğŸ¯ **Core Concept**

### **Discovery-Based Installation**
1. **Scan Network**: Automatically discover IO-Link devices
2. **MAC Validation**: Pull MAC address and validate with user
3. **Unit Assignment**: Assign devices to units based on subnet
4. **Database Storage**: Store device mappings for future use
5. **Scalable Architecture**: Support unlimited units and heaters

---

## ğŸ” **Installation Flow**

### **Step 1: Network Discovery**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Start Discovery â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scan Subnets    â”‚
â”‚ 192.168.20.x    â”‚
â”‚ 192.168.21.x    â”‚
â”‚ 192.168.22.x    â”‚
â”‚ ...             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Find IO-Links   â”‚
â”‚ - IP Address    â”‚
â”‚ - MAC Address   â”‚
â”‚ - Device Type   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validate MAC    â”‚
â”‚ [User Confirms] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Assign to Unit  â”‚
â”‚ [User Selects]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Save to DB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ **Technical Implementation**

### **1. IO-Link Discovery Script**
```python
# iolink-discovery-v2.py
class IoLinkDiscovery:
    def __init__(self):
        self.discovered_devices = []
        self.validated_devices = []
    
    def scan_subnet(self, subnet):
        """Scan subnet for IO-Link devices"""
        # Scan 192.168.{subnet}.x
        # Try common IO-Link ports
        # Extract MAC address and device info
    
    def validate_device(self, device):
        """Show MAC to user for validation"""
        # Display MAC address
        # Ask user to confirm
        # Return True/False
    
    def assign_to_unit(self, device):
        """Assign device to specific unit"""
        # Show available units
        # Let user select unit
        # Assign heater type (A, B, C, etc.)
```

### **2. Database Schema**
```sql
-- Device Registry
CREATE TABLE device_registry (
    id SERIAL PRIMARY KEY,
    mac_address VARCHAR(17) UNIQUE,
    ip_address VARCHAR(15),
    subnet INTEGER,
    unit_number INTEGER,
    heater_type VARCHAR(10), -- 'A', 'B', 'C', etc.
    device_name VARCHAR(100),
    is_validated BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Unit Configuration
CREATE TABLE unit_config (
    id SERIAL PRIMARY KEY,
    unit_number INTEGER UNIQUE,
    subnet INTEGER,
    host_ip VARCHAR(15),
    mqtt_port INTEGER DEFAULT 1883,
    frontend_port INTEGER,
    backend_port INTEGER,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### **3. MAC-Based Command System**
```python
# mac-based-commands.py
class MacBasedCommands:
    def __init__(self, db_connection):
        self.db = db_connection
    
    def get_device_by_mac(self, mac_address):
        """Get device info from database"""
        return self.db.query("SELECT * FROM device_registry WHERE mac_address = %s", [mac_address])
    
    def send_command(self, mac_address, port, state):
        """Send command using MAC as device ID"""
        device = self.get_device_by_mac(mac_address)
        if device:
            # Use MAC address in command URL
            url = f"http://{device['ip_address']}/iolinkmaster/port[{port}]/iolinkdevice/pdout/setdata"
            payload = {
                "device_id": mac_address,  # MAC as device identifier
                "port": port,
                "state": state
            }
            return self.send_http_command(url, payload)
```

---

## ğŸ“‹ **Installation Process**

### **Phase 1: Initial Setup**
```bash
./install-v1.02.sh --mode=discovery
```

**Steps:**
1. **System Check**: Verify Docker, Python, network access
2. **Database Setup**: Create PostgreSQL with device registry
3. **Network Scan**: Discover all IO-Link devices
4. **Device Validation**: MAC address confirmation

### **Phase 2: Unit Configuration**
```bash
./configure-unit.sh --unit=1 --subnet=20
```

**Steps:**
1. **Unit Creation**: Create unit configuration
2. **Device Assignment**: Assign discovered devices to unit
3. **Port Mapping**: Map IO-Link ports to heater sections
4. **Service Setup**: Configure Docker services for unit

### **Phase 3: Heater Configuration**
```bash
./configure-heater.sh --unit=1 --heater=A --mac=AA:BB:CC:DD:EE:FF
```

**Steps:**
1. **Heater Assignment**: Assign specific heater to unit
2. **Port Configuration**: Configure IO-Link ports
3. **MQTT Setup**: Configure MQTT topics
4. **Testing**: Test heater control

---

## ğŸ”§ **Discovery Script Features**

### **Network Scanning**
- **Subnet Detection**: Automatically detect available subnets
- **IO-Link Detection**: Find IO-Link masters on network
- **MAC Extraction**: Pull MAC addresses from devices
- **Device Classification**: Identify device types

### **User Interface**
- **Interactive Prompts**: Clear user prompts for validation
- **MAC Display**: Show MAC addresses clearly
- **Unit Selection**: Easy unit assignment interface
- **Progress Tracking**: Show installation progress

### **Validation System**
- **MAC Confirmation**: User confirms MAC matches device
- **Device Testing**: Test communication with device
- **Port Verification**: Verify IO-Link ports are accessible
- **Command Testing**: Test activate/deactivate commands

---

## ğŸ“Š **Multi-Unit Support**

### **Unit Structure**
```
Unit 1 (192.168.20.x)
â”œâ”€â”€ HTR-A (MAC: AA:BB:CC:DD:EE:01)
â”‚   â”œâ”€â”€ Port 1: Section 1
â”‚   â”œâ”€â”€ Port 2: Section 2
â”‚   â”œâ”€â”€ Port 3: Section 3
â”‚   â””â”€â”€ Port 4: Section 4
â”œâ”€â”€ HTR-B (MAC: AA:BB:CC:DD:EE:02)
â”‚   â”œâ”€â”€ Port 1: Section 1
â”‚   â”œâ”€â”€ Port 2: Section 2
â”‚   â”œâ”€â”€ Port 3: Section 3
â”‚   â””â”€â”€ Port 4: Section 4
â””â”€â”€ Temperature Sensor (Port 6)

Unit 2 (192.168.21.x)
â”œâ”€â”€ HTR-A (MAC: AA:BB:CC:DD:EE:03)
â”œâ”€â”€ HTR-B (MAC: AA:BB:CC:DD:EE:04)
â””â”€â”€ Temperature Sensor (Port 6)

Unit N (192.168.N.x)
â”œâ”€â”€ HTR-A (MAC: AA:BB:CC:DD:EE:XX)
â”œâ”€â”€ HTR-B (MAC: AA:BB:CC:DD:EE:YY)
â””â”€â”€ Temperature Sensor (Port 6)
```

### **Scalable Configuration**
- **Dynamic Unit Creation**: Add units as needed
- **Flexible Heater Assignment**: Assign heaters to any unit
- **Port Mapping**: Flexible port-to-section mapping
- **MQTT Topics**: Automatic topic generation

---

## ğŸš€ **Implementation Plan**

### **Week 1: Core Discovery System**
- [ ] Create IO-Link discovery script
- [ ] Implement MAC address extraction
- [ ] Create database schema
- [ ] Build user validation interface

### **Week 2: Unit Configuration**
- [ ] Create unit configuration system
- [ ] Implement device assignment
- [ ] Build port mapping system
- [ ] Create service generation

### **Week 3: Command System**
- [ ] Implement MAC-based commands
- [ ] Create device registry
- [ ] Build command routing
- [ ] Add error handling

### **Week 4: Testing & Documentation**
- [ ] Test multi-unit scenarios
- [ ] Validate MAC-based commands
- [ ] Create installation documentation
- [ ] Build troubleshooting tools

---

## ğŸ¯ **Benefits**

### **Scalability**
- âœ… **Unlimited Units**: Add as many units as needed
- âœ… **Multiple Heaters**: Support unlimited heaters per unit
- âœ… **Flexible Assignment**: Assign devices to any unit
- âœ… **Dynamic Configuration**: Configure without restart

### **Reliability**
- âœ… **MAC Validation**: Ensure correct device identification
- âœ… **Database Storage**: Persistent device registry
- âœ… **Error Handling**: Robust error detection and recovery
- âœ… **Testing**: Built-in validation and testing

### **Usability**
- âœ… **Interactive Installation**: Clear user prompts
- âœ… **Progress Tracking**: Show installation progress
- âœ… **Easy Management**: Simple device management
- âœ… **Troubleshooting**: Built-in diagnostic tools

---

## ğŸ” **Next Steps**

1. **Create Discovery Script**: Build IO-Link discovery with MAC extraction
2. **Design Database Schema**: Create device registry tables
3. **Build User Interface**: Create interactive installation prompts
4. **Implement MAC Commands**: Build MAC-based command system
5. **Test Multi-Unit**: Validate with multiple units and heaters

**Status**: ğŸŸ¡ **PLANNING COMPLETE - READY FOR IMPLEMENTATION** 